<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GPT-5 Nano Chat</title>
<style>
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }
  .message {
    margin-bottom: 1rem;
  }
  .user { color: #0b66ff; }
  .ai { color: #ff6600; }
  #inputArea {
    display: flex;
    border-top: 1px solid #333;
  }
  #messageInput {
    flex: 1;
    padding: 0.5rem;
    background: #222;
    color: #eee;
    border: none;
    outline: none;
  }
  #sendBtn {
    padding: 0 1rem;
    background: #0b66ff;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  #sendBtn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
</head>
<body>
  <div id="chat"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>

<script>
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

async function sendMessage() {
  const msg = inputEl.value.trim();
  if (!msg) return;
  appendMessage("user", msg);
  inputEl.value = "";
  sendBtn.disabled = true;

  const response = await fetch("https://ai.ethantytang11.workers.dev/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: msg })
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let aiMsgEl = appendMessage("ai", "");
  
  let done = false;
  while(!done) {
    const { value, done: readerDone } = await reader.read();
    done = readerDone;
    if (value) {
      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split("\n");
      for (const line of lines) {
        if (!line.startsWith("data:")) continue;
        const jsonStr = line.replace(/^data:\s*/, "");
        if (jsonStr === "[DONE]") break;
        try {
          const parsed = JSON.parse(jsonStr);
          const content = parsed.choices[0].delta?.content;
          if (content) aiMsgEl.textContent += content;
        } catch(e){}
      }
    }
  }

  sendBtn.disabled = false;
}

function appendMessage(role, text) {
  const div = document.createElement("div");
  div.className = `message ${role}`;
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  return div;
}
</script>
</body>
</html>
